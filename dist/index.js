// @bun
var $=function(t,i,n,s){var e=arguments.length,o=e<3?i:s===null?s=Object.getOwnPropertyDescriptor(i,n):s,f;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")o=Reflect.decorate(t,i,n,s);else for(var E=t.length-1;E>=0;E--)if(f=t[E])o=(e<3?f(o):e>3?f(i,n,o):f(i,n))||o;return e>3&&o&&Object.defineProperty(i,n,o),o};var P=(t,i)=>{if(typeof Reflect==="object"&&typeof Reflect.metadata==="function")return Reflect.metadata(t,i)};var x=(t)=>{return!isNaN(parseFloat(t))&&isFinite(t)};var M=(t)=>Array.isArray(t),X=(t)=>typeof t==="object";var l=(t)=>{return Number.isInteger(Number(t))};var T=()=>{let t=process.env.SECRET_KEY;if(!t)throw new Error("'SECRET_KEY' not found in .env file");return t};var At=new RegExp(/(\d+)(\d*)/,"m"),a=(t)=>Array.from({length:t},(i,n)=>n);var Ht=a(10).join("");var _=(t)=>{return Buffer.from(t)},A=(...t)=>{let i=new Bun.CryptoHasher("sha256",T());return t.forEach((n)=>{i.update(n)}),i.digest()},w=(t)=>JSON.stringify(t),B=(t)=>{return JSON.parse(t)};var v=new TextDecoder,h=(t)=>{return v.decode(t)};class b extends Map{obj(t){t&&c(t).forEach(([i,n])=>this.set(i,n))}map(t){t.forEach((i,n)=>{if(X(i))this.ass(n,i);else this.set(n,i)})}ass(t,i){if(!this.has(t))this.set(t,{});H(this.get(t),i)}lacks(t){return!this.has(t)}init(t,i){return this.has(t)?this.get(t):this.set(t,i).get(t)}}var{entries:c,hasOwn:Lt,freeze:Z}=Object;var H=Object.assign,y=(t)=>{return Object.keys(t).length};function Q(t){let i;return class extends t{constructor(...n){if(i)return i;super(...n);Z(this),i=this}}}var it=["charset","name","property","http-equiv"],nt=(t,i)=>{i.forEach((n)=>{for(let s of it)if(s in n){let e=n[s];t[`${s}_${s==="charset"?"":e}`]=n}})},st=(t,i)=>{i.forEach((n)=>{if("href"in n){let s=n.href;t[`${s}`]=n}})};class j{_head;constructor(t){this._head=new b(t)}set head(t){c(t).forEach(([i,n])=>{if(i==="title"||i==="base"){this._head.set(i,n);return}if(!M(n))return;switch(i){case"meta":return nt(this._head.init("meta",{}),n);case"link":return st(this._head.init("link",{}),n);case"script":this._head.init(i,[]),this._head.get(i).push(...n);return}})}get head(){return this._head}}class et{htmlHead=new b;head;constructor(){this.head=(t={})=>{let i=new j(this.htmlHead);i.head=t,this.htmlHead=i.head}}}var q=(t,i="",{maxAge:n,expires:s,path:e,domain:o,secure:f,httpOnly:E,sameSite:u})=>{if(n instanceof Date)n=n.getSeconds();if(s instanceof Date)s=s.toUTCString();else if(s===0)s=new Date().toUTCString();return[["Domain",o],["Expires",s],["Max-Age",n],["Secure",f],["HttpOnly",E],["Path",e],["SameSite",u]].reduce((r,[O,C])=>{if(C!==void 0)r.push(`${O}=${C}`);return r},[`${t}=${i}`]).join("; ")};var ot=(t,i=!1)=>{if(x(t))return[+t,l(t)?"int":"float"];if(i&&/\.\w+$/.test(t))return[t,"file"];if(t==="/")return[t,"-"];if(t.length===36&&t.match(/\-/g)?.length===4)return[t,"uuid"];return[t,"string"]},rt=(t)=>{let i=t.startsWith("/")?t:"/"+t,n=i.match(/(?<=\/)[^/].*?(?=\/|$)/g)??["/"],[s,e]=n.reduce(([o,f],E)=>{if(E.includes("<")){let u=E.match(/(?<=<)[^/].*?(?=>|$)/g);if(u?.length){let[g,r]=u[0].split(":");if(g&&r)o.push(g),f.push(r)}}else o.push(E===">"?"/":E);return[o,f]},[[],[]]);if(i.endsWith("/")&&i.length>1)s.push("/");return{parsed:s,args:e}};var ft=["int","float","file","uuid","string"];class Et{_storage=new b;set(t){let{parsed:i,path:n}=t,s=w(i);if(!this._storage.get(s))this._storage.set(s,t);else throw`path: ${n} already used.`}get(t){let{parsed:i}=rt(t),n={},s=this._storage.get(w(i));if(!s)for(let e of this._storage.keys()){let o=[],f=B(e);if(i.length===f.length){let E=f.map((r,O)=>{let C=ot(i[O],i.length-1===O);if(r===C[0])return C[0];if(ft.includes(C[1]))return o.push(C[0]),C[1];return r}),u=w(E);if(this._storage.has(u)){s=this._storage.get(u),s.args.forEach((r,O)=>{n[r]=o[O]});break}}}return[s,n]}}class I{date;constructor(t){this.date=t?new Date(t):new Date}delta(t=null,i=!1){let n=I.delta(this.date.getTime(),t);return i?new Date(n):n}timed(t){if(!t)return this.date;return[["year","FullYear"],["month","Month"],["day","Date"],["hour","Hours"],["minute","Minutes"],["second","Seconds"]].reduce((n,[s,e])=>{let o=t[s];return o?new Date(n[`set${e}`](n[`get${e}`]()+o)):n},new Date(this.date))}static delta(t,i=null){return i?i-t:t-Date.now()}static get now(){return Date.now()}}import{randomBytes as ut}from"crypto";class m{salt;constructor(t){this.salt=t}getSignature(t){let i=this.deriveKey().toString();return A(i,t).toString("base64")}deriveKey(){return A(this.salt)}sign(t){let i=this.getSignature(t),n=_(t+"."+i);return h(n)}unsign(t){if(!(t.indexOf(".")>-1))throw Error("No sep found");let i=t.indexOf("."),n=t.slice(0,i),s=t.slice(i+1);return this.verifySignature(n,s)}loadUnsign(t){if(this.unsign(t)){let i=_(t),n=_(".").toString()[0];if(!(n in i))throw Error("No sep found");let s=i.indexOf(n),e=i.subarray(0,s);return Buffer.from(e.toString(),"base64").toString("utf-8")}}verifySignature(t,i){return this.getSignature(t)==i?!0:!1}}var{CryptoHasher:St}=globalThis.Bun;class d{signer;constructor(t){this.signer=new m(t)}generate(t=21){let n=ut(t).toString("base64");if(n.endsWith("="))n=n.slice(0,-1);return this.signer.sign(n)}}function N(t){let i=new St("md5");return i.update(t),i.digest("hex")}class z{data;modified;new=!0;length=0;constructor(t={}){if(this.modified=!0,this.data={},this.length=y(t),this.length)this.new=!1;H(this.data,t)}set(t,i,n){if(!this.readonly&&t.data[i]!=n){if(this.modified=!0,!(i in t.data))this.length++;return t.data[i]=n,!0}return!1}get(t,i){if(i in t)return t[i];return t.data[i]}has(t,i){if(i in t.data)return!0;return!1}deleteProperty(t,i){if(!this.readonly&&i in t.data)this.modified=!0,delete t.data[i],this.length--;return!0}}class S extends z{sid;modified;readOnly;constructor(t="",i={},n=!1){super(i);this.sid=t;this.modified=!1,this.readOnly=n}get session(){return new Proxy(this,this)}}class R extends d{config;constructor(t,i){super(i??"salty");this.config=t}async openSession(t,i){if(t&&this.signer.unsign(t))return await this.fetchSession(t,i);return this.new}async fetchSession(t,i){return this.new}async saveSession(t,i,n=!1){return}get new(){return new S(this.generate(),{}).session}get readonly(){return new S(this.generate(),{},!0).session}get getExpiration(){let t=new Date,i=this.config.LIFETIME;return t.setDate(t.getDate()+i).toString()}setCookie(t,i,n=""){let s=null,e={};if(this.config.COOKIE_SAMESITE)s=this.config.COOKIE_SAMESITE;if(n)s=n;if(i===0)e.maxAge=i.toString();else e.expires=i;return q(this.config.COOKIE_NAME,t.sid,{domain:"",path:this.config.COOKIE_PATH,httpOnly:this.config.COOKIE_HTTPONLY,secure:this.config.COOKIE_SECURE,sameSite:s,...e})}async loadHeader(t,i){let n=async(e)=>{let o="";if(e)o=e.split(";").reduce((u,g)=>{let[r,O]=g.trim().split(/=(.*)/s);return u[r]=O,u},{}).session;let f=o;return await this.openSession(f,i)},s=t.headers;if(s){if("get"in s)return await n(s.get("cookie"));else if("cookie"in s)return await n(s.cookie)}return this.new}}var{file:p,gunzipSync:It,gzipSync:Ot,write:Ct}=globalThis.Bun;import{promises as Tt}from"fs";import{mkdirSync as Hi,writeFileSync as gt}from"fs";var G=(t,i="")=>{try{return gt(t,i,{flag:"wx"}),!0}catch(n){return!1}};class F{path;data;constructor(t){this.data=new Map,this.path=t+"/"}async init(t){let i=N(t),n=this.path+i,s=p(n);if(await s.exists()){let e=await s.arrayBuffer();try{let o=JSON.parse(h(It(e)));return o.f_timed=Date.now(),this.data.set(i,o),o}catch(o){}}return null}async checkLast(t){let i=new Date(t);if(i.setMinutes(i.getMinutes()+60),i.getTime()<Date.now())return!0;return!1}async get(t){if(t){let i=this.data.get(t);if(i==null)return await this.init(t);else{if(i&&"f_timed"in i){if(await this.checkLast(i.f_timed))return await this.init(t)}return i}}return null}async set(t,i){let n=N(t),s=this.path+n;G(s,""),await Ct(s,Ot(JSON.stringify(i))),i.f_timed=Date.now(),this.data.set(t,i)}async delete(t){let i=N(t);this.data.delete(i);let n=this.path+i;p(n).exists().then(async(s)=>{await Tt.unlink(n)}).catch()}}class K extends S{}class J extends R{isJWT;cacher;side=K;constructor(t,i=".sessions",n=!1){super(t);this.isJWT=n;this.cacher=new F(i)}life(t,i){let{LIFETIME:n,JWT_LIFETIME:s}=this.config;if(new I(i).timed({day:this.isJWT?s:n}).getTime()-new Date().getTime()>0)return!0;else return this.cacher.delete(t),!1}async fetchSession(t,i){let n=this.config.KEY_PREFIX+t,s=await this.cacher.get(n),e={};if(s){let o=!0;if("life"in s)o=this.life(n,s.life);e=o?JSON.parse(s.data):{}}return new this.side(t,e,i).session}async saveSession(t,i,n=!1){let s=(o)=>{if(i){let f=this.setCookie(t,o);if(i)i.set("Set-Cookie",f)}},e=this.config.KEY_PREFIX+t.sid;if(!t.length){if(!t.new&&(t.modified||n))this.cacher.delete(e),s(0);return}if(t.new&&t.modified){let o=new I().timed({day:this.config.LIFETIME}),f=JSON.stringify(t.data);await this.cacher.set(e,{data:f,life:I.now}),s(o)}return}}class D{client;query;f_timed;data;key;constructor(t,i,n){this.query=n,this.key=i,this.f_timed=Date.now(),this.data=new Map,this.client=t}async init(t){let i=await this.client.query({text:this.query+` where ${this.key} = $1`,values:[t]});for(let[n,s]of this.data)if(!s)this.data.delete(n);if(i.rowCount){let n=i.rows[0];return n.f_timed=Date.now(),this.data.set(t,n),n}else return this.data.set(t,null),null}async checkLast(t){let i=new Date(t);if(i.setMinutes(i.getMinutes()+15),i.getTime()<Date.now())return!0;return!1}async get(t){if(t){let i=this.data.get(t);if(i==null)return await this.init(t);else{if(i&&"f_timed"in i){if(await this.checkLast(i.f_timed))return await this.init(t)}return i}}return null}async set(t){if(this.key in t)t.f_timed=Date.now(),this.data.set(t[this.key],t)}async delete(t){this.data.delete(t)}}class W extends S{}class L extends R{sclass=W;client;pgc;constructor(t,i){super(i);this.client=t,this.pgc=new D(t,"sid","SELECT * FROM session")}async fetchSession(t){let i=this.config.KEY_PREFIX+t,n=await this.pgc.get(i),s={};if(n)s=JSON.parse(n.data);return new this.sclass(t,s).session}async saveSession(t,i,n,s=""){let e=this.config.KEY_PREFIX+t.sid;if(!Object.entries(t.data).length){if(t.modified||n){if(i){await this.client.query({text:"DELETE FROM session WHERE sid = $1",values:[e]}),await this.pgc.delete(e);let E=this.setCookie(t,0);i.header={"Set-Cookie":E}}}return}let o=new I().timed({day:this.config.LIFETIME}),f=JSON.stringify(t.data);if(i){let E=this.getExpiration;await this.client.query({text:"INSERT INTO session(sid, data, expiration) VALUES($1, $2, $3)",values:[e,f,E?E:null]}),await this.pgc.set({sid:e,data:f,expiration:E??"",life:I.now});let u=this.setCookie(t,o);i.header={"Set-Cookie":u}}}}var{CryptoHasher:ct}=globalThis.Bun;import{sign as V,verify as bt}from"jsonwebtoken";import{randomBytes as Rt}from"crypto";class U extends d{salt;constructor(){super("salty_jwt");this.salt="salty_jwt"}sign(t){let i={issuer:this.salt};return V({data:t},T(),i)}get random(){let t={issuer:this.salt},i={data:wt()};return V(i,T(),t)}jwt(){let t=this.generate();return new S(t).session}verify(t,i){try{let n=bt(t,T());if(n){let{data:s,iat:e,iss:o}=n;if(o==this.salt)if(i){let{days:f,hours:E,minutes:u,seconds:g}=i,r=new Date(e*1000);if(f)r=new Date(r.setDate(r.getDate()+f));else if(E)r=new Date(r.setHours(r.getHours()+E));else if(u)r=new Date(r.setMinutes(r.getMinutes()+u));else if(g)r=new Date(r.setSeconds(r.getSeconds()+g));if(r.getTime()-Date.now()>0)return s}else return s}}catch(n){}return null}open(t,i){if(t){let n=this.verify(t,i);if(n)return new S(t,n,!0).session}return this.jwt()}save(t){let i=t.data;if("access_token"in i)delete i.access_token;return this.sign(i)}new(t){return this.sign(t)}}function wt(t=64){return new ct("sha256").update(Rt(t)).digest("hex")}class Y{postgresClient;config={COOKIE_NAME:"session",COOKIE_DOMAIN:"127.0.0.1",COOKIE_PATH:"/",COOKIE_HTTPONLY:!0,COOKIE_SECURE:!0,REFRESH_EACH_REQUEST:!1,COOKIE_SAMESITE:"Strict",KEY_PREFIX:"session:",PERMANENT:!0,USE_SIGNER:!1,ID_LENGTH:32,FILE_THRESHOLD:500,LIFETIME:31,MAX_COOKIE_SIZE:4093,INTERFACE:"fs",STORAGE:".sessions",JWT_STORAGE:".jwt",JWT_LIFETIME:5};constructor({type:t="fs",dir:i}={}){t&&(this.config.INTERFACE=t),i&&this.initStorage(i)}initStorage(t){return this.config.STORAGE=t+"/"+this.config.STORAGE,this.config.JWT_STORAGE=t+"/"+this.config.JWT_STORAGE,this}get session(){if(this.config.INTERFACE==="postgres"&&this.postgresClient)return new L(this.postgresClient,this.config);return new J(this.config,this.config.STORAGE)}get jwt(){return new J(this.config,this.config.JWT_STORAGE)}}Y=$([Q,P("design:paramtypes",[Object])],Y);class dt{init(t){this.jwtInt=new U,this.session=t.session,this.jwt=t.jwt}}export{dt as Session,S as ServerSide,W as PostgreSession,L as PGInterface,D as PGCache,K as FSession,J as FSInterface,F as FSCached,R as AuthInterface,Y as Auth};
