// @bun
import{randomBytes as _}from"crypto";var{CryptoHasher:b,file:R,gunzipSync:y,gzipSync:g,write:N}=globalThis.Bun;import{promises as m,mkdirSync as c,writeFileSync as v}from"fs";import{sign as T,verify as o}from"jsonwebtoken";var f=(Y)=>Array.from({length:Y},(Z,$)=>$);var r=f(10).join(""),t=new RegExp(/(\d+)(\d*)/,"m");var M=Object.values;var{entries:I,hasOwn:a}=Object;var D=Object.assign,F=(Y)=>{return Object.keys(Y).length};var V=(Y)=>{return Buffer.from(Y)},j=(...Y)=>{let Z=new Bun.CryptoHasher("sha256",G());return Y.forEach(($)=>{Z.update($)}),Z.digest()};var G=()=>{let Y=process.env.SECRET_KEY;if(!Y)throw new Error("'SECRET_KEY' not found in .env file");return Y};class H{date;constructor(Y){this.date=Y?new Date(Y):new Date}delta(Y=null,Z=!1){let $=H.delta(this.date.getTime(),Y);return Z?new Date($):$}timed(Y){if(!Y)return this.date;return[["year","FullYear"],["month","Month"],["day","Date"],["hour","Hours"],["minute","Minutes"],["second","Seconds"]].reduce(($,[U,W])=>{let Q=Y[U];return Q?new Date($[`set${W}`]($[`get${W}`]()+Q)):$},new Date(this.date))}static delta(Y,Z=null){return Z?Z-Y:Y-Date.now()}static get now(){return Date.now()}}function K(Y){let Z=new b("md5");return Z.update(Y),Z.digest("hex")}var h=new TextDecoder,n={cookie:(Y,Z="",{maxAge:$,expires:U,path:W,domain:Q,secure:q,httpOnly:L,sameSite:E})=>{if($ instanceof Date)$=$.getSeconds();if(U instanceof Date)U=U.toUTCString();else if(U===0)U=new Date().toUTCString();return[["Domain",Q],["Expires",U],["Max-Age",$],["Secure",q],["HttpOnly",L],["Path",W],["SameSite",E]].reduce((B,[X,A])=>{if(A!==void 0)B.push(`${X}=${A}`);return B},[`${Y}=${Z}`]).join("; ")}},O={file:(Y,Z)=>{try{v(Y,Z??"",{flag:"wx"})}catch($){}return!0},dir:(Y)=>{return c(Y,{recursive:!0}),!0},decode(Y){return h.decode(Y)}};function p(Y=64){return new b("sha256").update(_(Y)).digest("hex")}class l{postgresClient;config={COOKIE_NAME:"session",COOKIE_DOMAIN:"127.0.0.1",COOKIE_PATH:"/",COOKIE_HTTPONLY:!0,COOKIE_SECURE:!0,REFRESH_EACH_REQUEST:!1,COOKIE_SAMESITE:"Strict",KEY_PREFIX:"session:",PERMANENT:!0,USE_SIGNER:!1,ID_LENGTH:32,FILE_THRESHOLD:500,LIFETIME:31,MAX_COOKIE_SIZE:4093,INTERFACE:"fs",STORAGE:".sessions",JWT_STORAGE:".jwt",JWT_LIFETIME:5};constructor({type:Y="fs",dir:Z}={}){Y&&(this.config.INTERFACE=Y),Z&&this.initStorage(Z)}initStorage(Y){return this.config.STORAGE=Y+"/"+this.config.STORAGE,this.config.JWT_STORAGE=Y+"/"+this.config.JWT_STORAGE,this}get session(){return new C(this.config,this.config.STORAGE)}get jwt(){return new C(this.config,this.config.JWT_STORAGE)}}class w{data;modified;new=!0;length=0;constructor(Y={}){if(this.modified=!0,this.data={},this.length=F(Y),this.length)this.new=!1;D(this.data,Y)}set(Y,Z,$){if(!this.readonly&&Y.data[Z]!=$){if(this.modified=!0,!(Z in Y.data))this.length++;return Y.data[Z]=$,!0}return!1}get(Y,Z){if(Z in Y)return Y[Z];return Y.data[Z]}has(Y,Z){if(Z in Y.data)return!0;return!1}deleteProperty(Y,Z){if(!this.readonly&&Z in Y.data)this.modified=!0,delete Y.data[Z],this.length--;return!0}}class J extends w{sid;modified;readOnly;constructor(Y="",Z={},$=!1){super(Z);this.sid=Y;this.modified=!1,this.readOnly=$}get session(){return new Proxy(this,this)}}class u{salt;constructor(Y){this.salt=Y}getSignature(Y){let Z=this.deriveKey().toString();return j(Z,Y).toString("base64")}deriveKey(){return j(this.salt)}sign(Y){let Z=this.getSignature(Y),$=V(Y+"."+Z);return O.decode($)}unsign(Y){if(!(Y.indexOf(".")>-1))throw Error("No sep found");let Z=Y.indexOf("."),$=Y.slice(0,Z),U=Y.slice(Z+1);return this.verifySignature($,U)}loadUnsign(Y){if(this.unsign(Y)){let Z=V(Y),$=V(".").toString()[0];if(!($ in Z))throw Error("No sep found");let U=Z.indexOf($),W=Z.subarray(0,U);return Buffer.from(W.toString(),"base64").toString("utf-8")}}verifySignature(Y,Z){return this.getSignature(Y)==Z?!0:!1}}class P{signer;constructor(Y){this.signer=new u(Y)}generate(Y=21){let $=_(Y).toString("base64");if($.endsWith("="))$=$.slice(0,-1);return this.signer.sign($)}}class x extends P{config;constructor(Y,Z){super(Z??"salty");this.config=Y}async openSession(Y,Z){if(Y&&this.signer.unsign(Y))return await this.fetchSession(Y,Z);return this.new}async fetchSession(Y,Z){return this.new}async saveSession(Y,Z,$=!1){return}get new(){return new J(this.generate(),{}).session}get readonly(){return new J(this.generate(),{},!0).session}get getExpiration(){let Y=new Date,Z=this.config.LIFETIME;return Y.setDate(Y.getDate()+Z).toString()}setCookie(Y,Z,$=""){let U=null,W={};if(this.config.COOKIE_SAMESITE)U=this.config.COOKIE_SAMESITE;if($)U=$;if(Z===0)W.maxAge=Z.toString();else W.expires=Z;return n.cookie(this.config.COOKIE_NAME,Y.sid,{domain:"",path:this.config.COOKIE_PATH,httpOnly:this.config.COOKIE_HTTPONLY,secure:this.config.COOKIE_SECURE,sameSite:U,...W})}async loadHeader(Y,Z){let $=async(W)=>{let Q="";if(W)Q=W.split(";").reduce((E,z)=>{let[B,X]=z.trim().split(/=(.*)/s);return E[B]=X,E},{}).session;let q=Q;return await this.openSession(q,Z)},U=Y.headers;if(U){if("get"in U)return await $(U.get("cookie"));else if("cookie"in U)return await $(U.cookie)}return this.new}}class k extends J{}class S{path;data;constructor(Y){this.data=new Map,this.path=Y+"/"}async init(Y){let Z=K(Y),$=this.path+Z,U=R($);if(await U.exists()){let W=await U.arrayBuffer();try{let Q=JSON.parse(O.decode(y(W)));return Q.f_timed=Date.now(),this.data.set(Z,Q),Q}catch(Q){}}return null}async checkLast(Y){let Z=new Date(Y);if(Z.setMinutes(Z.getMinutes()+60),Z.getTime()<Date.now())return!0;return!1}async get(Y){if(Y){let Z=this.data.get(Y);if(Z==null)return await this.init(Y);else{if(Z&&"f_timed"in Z){if(await this.checkLast(Z.f_timed))return await this.init(Y)}return Z}}return null}async set(Y,Z){let $=K(Y),U=this.path+$;O.file(U,""),await N(U,g(JSON.stringify(Z))),Z.f_timed=Date.now(),this.data.set(Y,Z)}async delete(Y){let Z=K(Y);this.data.delete(Z);let $=this.path+Z;R($).exists().then(async(U)=>{await m.unlink($)}).catch()}}class C extends x{isJWT;cacher;side=k;constructor(Y,Z=".sessions",$=!1){super(Y);this.isJWT=$;this.cacher=new S(Z)}life(Y,Z){let{LIFETIME:$,JWT_LIFETIME:U}=this.config;if(new H(Z).timed({day:this.isJWT?U:$}).getTime()-new Date().getTime()>0)return!0;else return this.cacher.delete(Y),!1}async fetchSession(Y,Z){let $=this.config.KEY_PREFIX+Y,U=await this.cacher.get($),W={};if(U){let Q=!0;if("life"in U)Q=this.life($,U.life);W=Q?JSON.parse(U.data):{}}return new this.side(Y,W,Z).session}async saveSession(Y,Z,$=!1){let U=(Q)=>{if(Z){let q=this.setCookie(Y,Q);if(Z)Z.set("Set-Cookie",q)}},W=this.config.KEY_PREFIX+Y.sid;if(!Y.length){if(!Y.new&&(Y.modified||$))this.cacher.delete(W),U(0);return}if(Y.new&&Y.modified){let Q=new H().timed({day:this.config.LIFETIME}),q=JSON.stringify(Y.data);await this.cacher.set(W,{data:q,life:H.now}),U(Q)}return}}class d{client;query;f_timed;data;key;constructor(Y,Z,$){this.query=$,this.key=Z,this.f_timed=Date.now(),this.data=new Map,this.client=Y}async init(Y){let Z=await this.client.query({text:this.query+` where ${this.key} = $1`,values:[Y]});for(let[$,U]of this.data)if(!U)this.data.delete($);if(Z.rowCount){let $=Z.rows[0];return $.f_timed=Date.now(),this.data.set(Y,$),$}else return this.data.set(Y,null),null}async checkLast(Y){let Z=new Date(Y);if(Z.setMinutes(Z.getMinutes()+15),Z.getTime()<Date.now())return!0;return!1}async get(Y){if(Y){let Z=this.data.get(Y);if(Z==null)return await this.init(Y);else{if(Z&&"f_timed"in Z){if(await this.checkLast(Z.f_timed))return await this.init(Y)}return Z}}return null}async set(Y){if(this.key in Y)Y.f_timed=Date.now(),this.data.set(Y[this.key],Y)}async delete(Y){this.data.delete(Y)}}class i extends P{salt;constructor(){super("salty_jwt");this.salt="salty_jwt"}sign(Y){let Z={issuer:this.salt};return T({data:Y},G(),Z)}get random(){let Y={issuer:this.salt},Z={data:p()};return T(Z,G(),Y)}jwt(){let Y=this.generate();return new J(Y).session}verify(Y,Z){try{let $=o(Y,G());if($){let{data:U,iat:W,iss:Q}=$;if(Q==this.salt)if(Z){let{days:q,hours:L,minutes:E,seconds:z}=Z,B=new Date(W*1000);if(q)B=new Date(B.setDate(B.getDate()+q));else if(L)B=new Date(B.setHours(B.getHours()+L));else if(E)B=new Date(B.setMinutes(B.getMinutes()+E));else if(z)B=new Date(B.setSeconds(B.getSeconds()+z));if(B.getTime()-Date.now()>0)return U}else return U}}catch($){}return null}open(Y,Z){if(Y){let $=this.verify(Y,Z);if($)return new J(Y,$,!0).session}return this.jwt()}save(Y){let Z=Y.data;if("access_token"in Z)delete Z.access_token;return this.sign(Z)}new(Y){return this.sign(Y)}}class s{fs;f_timed;data;key;dir;constructor({dir:Y,fs:Z,key:$}){this.dir=Y+"/ffs",this.key=$,this.f_timed=Date.now(),this.data=new Map,this.fs=this.dir+`/${Z}.json`}async init(){if(O.dir(this.dir)&&O.file(this.fs,"{}"))R(this.fs).text().then((Y)=>{let Z=JSON.parse(Y);this.data=new Map(I(Z))}).catch((Y)=>{})}async get(Y){let Z=this.data.get(Y);if(Z)return Z;return null}async set(Y){if(this.key in Y){let Z=await R(this.fs).text();if(Z){let $=JSON.parse(Z),U=Y[this.key];$[U]=Y,await N(this.fs,JSON.stringify($))}this.data.set(Y[this.key],Y)}}async delete(Y){if(await this.get(Y)){let Z=await R(this.fs).text();if(Z){let $=JSON.parse(Z.toString());if(Y in $)delete $[Y],await N(this.fs,JSON.stringify($));this.data.delete(Y)}}}async json(){let Y=await R(this.fs).text(),Z=JSON.parse(Y);return M(Z)}}export{K as decodeSID,J as ServerSide,d as PGCache,i as JWTInterface,s as Fjson,k as FSession,x as AuthInterface,l as Auth};
